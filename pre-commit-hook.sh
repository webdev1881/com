#!/bin/sh

# =====================================================
# Pre-commit hook –¥–ª—è –∞–¥–¥–æ–Ω–∞ COM
# =====================================================
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ .git/hooks/pre-commit
# –∏ —Å–¥–µ–ª–∞—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º: chmod +x .git/hooks/pre-commit

set -e

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üîç –ó–∞–ø—É—Å–∫ pre-commit –ø—Ä–æ–≤–µ—Ä–æ–∫...${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è npm
if ! command -v npm &> /dev/null; then
    echo -e "${RED}‚ùå npm –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ Vue.js${NC}"
    exit 0
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É static –¥–ª—è npm –∫–æ–º–∞–Ω–¥
cd static/

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–∏–Ω–≥–∞
echo -e "${YELLOW}üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ ESLint...${NC}"
if ! npm run lint; then
    echo -e "${RED}‚ùå ESLint –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞!${NC}"
    echo -e "${YELLOW}üí° –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –ª–∏–Ω—Ç–∏–Ω–≥–∞ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ ESLint –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞${NC}"

# 2. –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
echo -e "${YELLOW}üî® –°–±–æ—Ä–∫–∞ Vue.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...${NC}"
if ! npm run build; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏!${NC}"
    echo -e "${YELLOW}üí° –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ —Å–±–æ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞${NC}"

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–µ–Ω—å
cd ..

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Python —Ñ–∞–π–ª–æ–≤ (–±–∞–∑–æ–≤–∞—è)
echo -e "${YELLOW}üêç –ü—Ä–æ–≤–µ—Ä–∫–∞ Python —Ñ–∞–π–ª–æ–≤...${NC}"
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ __pycache__ –≤ –∫–æ–º–º–∏—Ç–µ
if git diff --cached --name-only | grep -q "__pycache__"; then
    echo -e "${RED}‚ùå –ù–∞–π–¥–µ–Ω—ã __pycache__ —Ñ–∞–π–ª—ã –≤ –∫–æ–º–º–∏—Ç–µ!${NC}"
    echo -e "${YELLOW}üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .gitignore –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è __pycache__${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Python —Ñ–∞–π–ª–æ–≤
for file in $(git diff --cached --name-only --diff-filter=ACM | grep "\.py$"); do
    if [ -f "$file" ]; then
        if ! python -m py_compile "$file"; then
            echo -e "${RED}‚ùå –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ $file${NC}"
            exit 1
        fi
    fi
done
echo -e "${GREEN}‚úÖ Python —Ñ–∞–π–ª—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã${NC}"

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–º–º–∏—Ç–∞
echo -e "${YELLOW}üìè –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π...${NC}"
CHANGED_FILES=$(git diff --cached --name-only | wc -l)
if [ "$CHANGED_FILES" -gt 50 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ú–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤ –≤ –∫–æ–º–º–∏—Ç–µ ($CHANGED_FILES)${NC}"
    echo -e "${YELLOW}üí° –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–º–∏—Ç–æ–≤${NC}"
fi

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
if [ -f ".git/COMMIT_EDITMSG" ]; then
    COMMIT_MSG=$(head -n 1 .git/COMMIT_EDITMSG)
    if [ ${#COMMIT_MSG} -lt 10 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  –ö–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞${NC}"
        echo -e "${YELLOW}üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–æ–≤${NC}"
    fi
fi

# 6. –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –∫–æ–º–º–∏—Ç
echo -e "${YELLOW}üì¶ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...${NC}"
git add static/dist/

echo -e "${GREEN}‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! –ö–æ–º–º–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω.${NC}"
exit 0
